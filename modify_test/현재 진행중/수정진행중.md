# 키움증권 자동매매 프로젝트 계획서

## 프로젝트 개요
키움증권 REST API를 활용한 자동매매 시스템 개발 및 개선

## 현재 상태 (2025-01-30)
- ✅ 기본 자동매매 시스템 구현 완료
- ✅ PyQt5 GUI 개선 완료 (main.ui → 순수 코드)
- ✅ 반응형 레이아웃 적용 완료

## 진행 중인 작업

### 1. 설정 관리 시스템 개선 ✅
**상태**: 완료
**목표**: 
- 설정값을 JSON 파일로 저장/로드
- logs 폴더 생성 및 다양한 로그 분류 저장

**세부 작업**:
- [x] settings.json 파일로 설정 저장 시스템
- [x] logs 폴더 자동 생성
- [x] 로그 분류 (매매기록, 에러, TR요청, 일반)
- [x] 일별 로그 파일 분리
- [x] SettingsManager 클래스 구현
- [x] JSON 기반 설정 저장/로드
- [x] loguru를 활용한 구조화된 로깅

### 2. 다중 매수 조건식 시스템 ✅
**상태**: 완료
**목표**: 
- 여러 매수 조건식 동시 선택
- 조건식별 개별 매매 시간 설정

**세부 작업**:
- [x] 매수 조건식 다중 선택 UI (QListWidget 사용)
- [x] 다중 조건식 실시간 등록/해제 로직
- [x] 조건식별 설정값 저장/로드
- [x] 실시간 매수 조건 확인 로직 수정
- [ ] 조건식별 시간 설정 테이블 (다음 단계)

### 3. 매도 조건 옵션 시스템 ✅
**상태**: 완료
**목표**: 
- 매도 조건식 선택적 사용
- 조건식 미선택시 기본 손절/익절 로직 사용

**세부 작업**:
- [x] 매도 조건식 사용/미사용 체크박스
- [x] 조건식 미사용시 기본 로직 동작
- [x] 매도 로직 우선순위 설정
- [x] UI 토글 기능 구현

### 4. 데이터 저장 시스템 개선 ✅
**상태**: 완료
**목표**: 
- realtime_tracking_df.pkl 파일 생성 문제 해결
- 데이터 손실 방지

**세부 작업**:
- [x] 파일 로드/저장 로직 개선
- [x] 강제 저장 기능 추가
- [x] 프로그램 종료시 자동 저장
- [x] 백업 파일 시스템

## 다음 단계 작업

### Phase 1: 조건식별 시간 설정 (우선순위: 높음) 🔄
- 조건식별 개별 매매 시간 설정 테이블
- 시간대별 활성화/비활성화 로직
- 예상 소요시간: 2-3시간

### Phase 2: UI/UX 개선 (우선순위: 중간)
- 실시간 상태 표시 개선
- 매매 현황 알림 시스템
- 예상 소요시간: 2-3시간

### Phase 3: 안정성 및 최적화 (우선순위: 낮음)
- 에러 핸들링 강화
- 성능 최적화
- 예상 소요시간: 3-4시간

### Phase 4: 고급 기능 (우선순위: 낮음)
- 백테스팅 기능
- 전략 분석 도구
- 예상 소요시간: 5-6시간

## 파일 구조 계획

```
project/
├── kiwoom_rest_test1.py          # 메인 GUI 파일
├── config.py                     # API 설정
├── utils.py                      # 유틸리티 함수
├── tr_process_functions.py       # TR 처리 함수
├── websocket_functions.py        # 웹소켓 처리
├── settings.json                 # 설정 파일 (새로 추가)
├── realtime_tracking_df.pkl      # 실시간 추적 데이터
├── logs/                         # 로그 폴더 (새로 추가)
│   ├── trading_YYYYMMDD.log     # 매매 기록
│   ├── error_YYYYMMDD.log       # 에러 로그
│   ├── tr_YYYYMMDD.log          # TR 요청 로그
│   └── general_YYYYMMDD.log     # 일반 로그
└── project_plan.md              # 이 파일
```

## 주요 개선 사항

### 완료된 개선사항 (2025-01-30)
1. ✅ UI 코드화 (main.ui 제거)
2. ✅ 반응형 레이아웃
3. ✅ 모니터 크기 독립적 설계
4. ✅ pickle 파일 생성 문제 해결
5. ✅ JSON 기반 설정 관리 시스템
6. ✅ 구조화된 로그 시스템 (loguru)
7. ✅ 다중 매수 조건식 지원
8. ✅ 매도 조건식 선택적 사용
9. ✅ 상세한 매매 로그 기록

### 새로운 기능들
- **SettingsManager**: JSON 파일 기반 설정 관리
- **다중 매수 조건식**: 여러 조건식 동시 선택 가능
- **선택적 매도 조건식**: 체크박스로 매도 조건식 사용/미사용 설정
- **구조화된 로깅**: 
  - `logs/general_YYYYMMDD.log`: 일반 로그
  - `logs/error_YYYYMMDD.log`: 에러 로그  
  - `logs/tr_YYYYMMDD.log`: TR 요청 로그
  - `logs/trading_YYYYMMDD.log`: 매매 기록 로그

## 기술적 고려사항

### 1. 성능
- 다중 조건식 처리시 메모리 사용량 모니터링
- 실시간 데이터 처리 최적화

### 2. 안정성
- 네트워크 연결 끊김 대응
- API 제한 관리
- 데이터 손실 방지

### 3. 사용성
- 직관적인 UI 설계
- 설정 백업/복원 기능
- 상태 표시 개선

## 테스트 계획

### Unit Test
- [ ] 설정 저장/로드 테스트
- [ ] 로그 시스템 테스트
- [ ] 조건식 처리 테스트

### Integration Test
- [ ] 전체 매매 시나리오 테스트
- [ ] 다중 조건식 동작 테스트
- [ ] 에러 상황 대응 테스트

## 위험 요소 및 대응방안

### 1. API 제한
- **위험**: 과도한 요청으로 인한 API 차단
- **대응**: 요청 간격 관리, 큐 시스템 구현

### 2. 데이터 손실
- **위험**: 프로그램 비정상 종료시 설정/데이터 손실
- **대응**: 자동 백업, 복구 시스템

### 3. 조건식 충돌
- **위험**: 여러 조건식이 동시에 동일 종목 매수 시도
- **대응**: 중복 매수 방지 로직

---

**최종 업데이트**: 2025-01-30 (Phase 1-3 완료)
**다음 리뷰**: Phase 4 조건식별 시간 설정 완료 후

## 구현 완료 요약

### 1. 설정 저장 시스템 ✅
- `settings.json` 파일로 모든 설정 저장
- UI 값들이 자동으로 JSON 형태로 저장됨
- 프로그램 재시작 시 이전 설정 자동 복원

### 2. 로그 시스템 ✅  
- `logs/` 폴더에 4가지 유형별 로그 파일 생성
- 일별 로그 파일 자동 생성 및 로테이션
- 매매 관련 상세 로그 기록

### 3. 다중 매수 조건식 ✅
- QListWidget으로 여러 조건식 동시 선택 가능
- 선택된 모든 조건식에 대해 실시간 등록
- 각 조건식별로 매수 신호 처리

### 4. 선택적 매도 조건식 ✅
- 체크박스로 매도 조건식 사용/미사용 선택
- 미사용시 기본 손절/익절 로직만 동작
- 매도 우선순위: 조건식 > 손절 > 익절